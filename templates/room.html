{% extends 'base.html' %} {% block content %}

<div class="room-container">
  {% if not chat_started %}
  <div class="setup-container">
    <div class="setup-header">
      <h1>Room Setup</h1>
      <div class="room-code-display">
        <span class="code-label">Room Code</span>
        <span class="code-value">{{code}}</span>
        <button class="link" onclick="copyText('{{base_url}}room/{{ code }}')">
          Copy Link üîó
        </button>
      </div>
    </div>

    <div class="survey-card">
      <h2>Your Preferences</h2>
      <p class="survey-description">Help us find movies you'll love</p>

      <div class="survey-form">
        <div class="form-field">
          <label for="preferences">What do you enjoy?</label>
          <textarea
            id="preferences"
            rows="4"
            placeholder="Tell us about your favorite genres, actors, directors, or themes..."
          ></textarea>
        </div>

        <div class="form-field">
          <label for="min_rating">Minimum Rating</label>
          <input
            type="number"
            id="min_rating"
            min="1"
            max="10"
            step="0.1"
            placeholder="7.0"
          />
          <span class="field-hint">IMDB rating from 1-10</span>
        </div>

        <button onclick="submitSurvey()" class="btn-submit hover-effect">
          Submit Preferences
        </button>
      </div>
    </div>

    {% if is_host %}
    <div class="host-controls">
      <button
        id="start-chat-btn"
        onClick="startChat()"
        class="btn-start hover-effect"
        disabled
      >
        Start Session
      </button>
      <p class="host-note" id="host-status">
        Everyone must submit their preferences first
      </p>
    </div>
    {% endif %}
  </div>
  {% else %}
  <div class="session-container">
    <div class="movie-section">
      <div class="section-header">
        <h2>Discover Movies</h2>
        <span class="movie-count">{{movies|length}} available</span>
      </div>

      <div id="card-stack" class="card-stack">
        {% for movie in movies %}
        <div
          class="movie-card"
          data-movie-id="{{movie.id}}"
          style="z-index: {{loop.index0}}"
        >
          <div class="movie-poster">
            {% if movie.poster and movie.poster != 'N/A' %}
            <img
              src="{{movie.poster}}"
              alt="{{movie.title}}"
              class="poster-img"
            />
            {% endif %}
            <div class="movie-info">
              <h3>{{movie.title}}</h3>
              <p class="movie-meta">{{movie.year}} ‚Ä¢ ‚≠ê {{movie.rating}}</p>
              {% if movie.genre and movie.genre != 'N/A' %}
              <p class="movie-genre">{{movie.genre}}</p>
              {% endif %} {% if movie.plot and movie.plot != 'No description
              available.' %}
              <p class="movie-plot">{{movie.plot}}</p>
              {% endif %}
            </div>
          </div>
        </div>
        {% endfor %}
        <div id="no-more-cards" class="no-cards" style="display: none">
          <div class="empty-state">
            <div class="empty-icon">üé¨</div>
            <h3>No more movies!</h3>
            <p>Wait for others to rate movies...</p>
          </div>
        </div>
      </div>

      <div class="swipe-buttons">
        <button class="btn-dislike" onclick="swipeLeft()">
          <span class="icon">‚úï</span>
        </button>
        <button class="btn-like" onclick="swipeRight()">
          <span class="icon">‚úì</span>
        </button>
      </div>
    </div>

    <div class="chat-section">
      <div class="chat-header">
        <h3>Room {{code}}</h3>
      </div>
      <div class="messages" id="messages"></div>
      <div class="chat-input">
        <input type="text" placeholder="Send a message..." id="message" />
        <button type="button" id="send-btn" onClick="sendMessage()">
          Send
        </button>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<style></style>

<script type="text/javascript">


  const messages = document.getElementById("messages");

  const createMessage = (name, msg) => {
    if (!messages) return;
    const content = `
      <div class="text">
          <span>
              <strong>${name}</strong>: ${msg}
          </span>
          <span class="muted">
              ${new Date().toLocaleString()}
          </span>
      </div>
      `;
    messages.innerHTML += content;
  };

  socket.on("message", (data) => {
    createMessage(data.name, data.message);
  });

  const sendMessage = () => {
    const message = document.getElementById("message");
    if (message.value == "") return;
    socket.emit("message", { data: message.value });
    message.value = "";
  };

  const sendTrue = () => {
      socket.emit("message", { data: "True" });
  };

  const sendFalse = () => {
      socket.emit("message", { data: "False" });
  };

  const startChat = () => {

    console.log("Starting chat...");
    socket.emit("start_chat");
  };

  socket.on("start_chat_error", (data) => {
      alert(data.message);
  });

  socket.on("chat_started", () => {
      console.log('Chat started event received, reloading page...');
      const msgInput = document.getElementById("message");
      const sendBtn = document.getElementById("send-btn");
      const trueBtn = document.getElementById("true-btn");
      const falseBtn = document.getElementById("false-btn");
      const startBtn = document.getElementById("start-chat-btn");

      if (msgInput) msgInput.disabled = false;
      if (sendBtn) sendBtn.disabled = false;
      if (trueBtn) trueBtn.disabled = false;
      if (falseBtn) falseBtn.disabled = false;
      if (startBtn) startBtn.style.display = "none";

      location.reload();
  });

  const completeSurvey = () => {
      socket.emit("survey", { data: ["grah", "hi", "hf"] });
  };

  const submitSurvey = () => {


      const preferences = document.getElementById('preferences').value;
      const minRating = parseFloat(document.getElementById('min_rating').value);

      if (!preferences || !minRating || minRating < 1 || minRating > 10) {
          alert('Please fill out both survey fields!');
          return;
      }

      console.log('Submitting survey:', { preferences, min_rating: minRating });

      if (!socket || !socket.connected) {
          alert('Not connected to server. Please refresh and try again.');
          console.error('Socket not connected');
          return;
      }

      try {
          socket.emit('survey', {
              data: {
                  preferences: preferences,
                  min_rating: minRating
              }
          });
          console.log('Survey emit called successfully');
      } catch (error) {
          console.error('Error emitting survey:', error);
          alert('Error submitting survey. Please try again.');
      }
  };

  let surveySubmitted = false;

  socket.on('survey_received', (data) => {
      console.log('Survey received by server:', data);
      surveySubmitted = true;
      const surveyForm = document.querySelector('.survey-form');
      if (surveyForm) surveyForm.style.display = 'none';
      alert('Survey submitted successfully!');
      socket.emit('check_all_surveys_complete');
  });

  setTimeout(() => {
      if (surveySubmitted) {
          console.log('Survey was successfully submitted');
      }
  }, 1000);

  socket.on('all_surveys_complete', (data) => {
      const startBtn = document.getElementById('start-chat-btn');
      const hostStatus = document.getElementById('host-status');
      if (startBtn) {
          if (data.ready) {
              startBtn.disabled = false;
              if (hostStatus) {
                  hostStatus.textContent = 'All members ready! You can start now.';
                  hostStatus.style.color = '#2ecc71';
              }
          } else {
              startBtn.disabled = true;
              if (hostStatus) {
                  hostStatus.textContent = `Waiting for ${data.pending} member(s) to submit preferences...`;
                  hostStatus.style.color = 'var(--muted)';
              }
          }
      }
  });

  // Tinder-style swipe functionality
  let isDragging = false;
  let startX = 0;
  let currentX = 0;
  let currentCard = null;

  function initCard(card) {
      if (!card) return;

      card.addEventListener('mousedown', startDrag);
      card.addEventListener('touchstart', startDrag);
  }

  function startDrag(e) {
      const card = e.currentTarget;
      if (card !== getTopCard()) return;

      isDragging = true;
      currentCard = card;
      startX = e.type === 'mousedown' ? e.clientX : e.touches[0].clientX;

      // Disable transition during drag
      currentCard.style.transition = 'none';

      document.addEventListener('mousemove', drag);
      document.addEventListener('touchmove', drag);
      document.addEventListener('mouseup', endDrag);
      document.addEventListener('touchend', endDrag);
  }

  function drag(e) {
      if (!isDragging || !currentCard) return;

      e.preventDefault();
      currentX = e.type === 'mousemove' ? e.clientX : e.touches[0].clientX;
      const deltaX = currentX - startX;
      const rotation = deltaX * 0.1;

      currentCard.style.transform = `translateX(${deltaX}px) rotate(${rotation}deg)`;

      // Visual feedback
      if (deltaX > 50) {
          currentCard.style.borderColor = '#2ecc71';
      } else if (deltaX < -50) {
          currentCard.style.borderColor = '#ff6b6b';
      } else {
          currentCard.style.borderColor = '#ccc';
      }
  }

  function endDrag(e) {
      if (!isDragging || !currentCard) return;

      isDragging = false;
      const deltaX = currentX - startX;

      // Re-enable transition
      currentCard.style.transition = '';

      document.removeEventListener('mousemove', drag);
      document.removeEventListener('touchmove', drag);
      document.removeEventListener('mouseup', endDrag);
      document.removeEventListener('touchend', endDrag);

      if (Math.abs(deltaX) > 100) {
          // Swipe threshold met
          if (deltaX > 0) {
              swipeRight();
          } else {
              swipeLeft();
          }
      } else {
          // Return to center
          currentCard.style.transform = '';
          currentCard.style.borderColor = '#ccc';
      }

      currentCard = null;
  }

  function getTopCard() {
      const cards = document.querySelectorAll('.card-stack .movie-card');
      return cards.length > 0 ? cards[cards.length - 1] : null;
  }

  function swipeRight() {
      const card = getTopCard();
      if (!card) return;

      const movieId = card.dataset.movieId;
      card.style.transform = 'translateX(1000px) rotate(30deg)';
      card.style.opacity = '0';

      setTimeout(() => {
          card.remove();
          checkNoCards();
      }, 300);

      socket.emit('movie_choice', { movie_id: movieId, choice: 'like' });
  }

  function swipeLeft() {
      const card = getTopCard();
      if (!card) return;

      const movieId = card.dataset.movieId;
      card.style.transform = 'translateX(-1000px) rotate(-30deg)';
      card.style.opacity = '0';

      setTimeout(() => {
          card.remove();
          checkNoCards();
      }, 300);

      socket.emit('movie_choice', { movie_id: movieId, choice: 'dislike' });
  }

  function checkNoCards() {
      const cards = document.querySelectorAll('.card-stack .movie-card');
      const noCardsMsg = document.getElementById('no-more-cards');
      if (cards.length === 0) {
          noCardsMsg.style.display = 'flex';
          socket.emit('get_updated_feed');
      } else {
          noCardsMsg.style.display = 'none';
      }
  }

  const movieCards = document.querySelectorAll('.movie-card');
  if (movieCards.length > 0) {
    movieCards.forEach(card => initCard(card));
  }

  socket.on('feed_update', (data) => {
      console.log('Feed updated by another user:', data.member_id);
      socket.emit('get_updated_feed');
  });

  socket.on('voting_complete', (data) => {
      const movies = data.top_movies;

      const movieSection = document.querySelector('.movie-section');
      if (movieSection) {
          let resultsHTML = '<h2>üèÜ Voting Results - Top 3 Movies! üèÜ</h2>';
          resultsHTML += '<div class="results-container">';

          movies.forEach((movie, idx) => {
              const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : 'ü•â';
              resultsHTML += `
                  <div class="result-card" style="background: linear-gradient(135deg, rgba(115, 110, 225, ${0.3 - idx * 0.08}), rgba(235, 88, 85, ${0.2 - idx * 0.05})); padding: 2rem; border-radius: 15px; margin-bottom: 1.5rem; border: 2px solid rgba(115, 110, 225, ${0.5 - idx * 0.1});">
                      <h3 style="font-size: 2.5rem; margin: 0; color: #fff;">${medal} #${idx + 1}</h3>
                      <h2 style="font-size: 2rem; margin: 0.5rem 0; color: #fff;">${movie.title}</h2>
                      <p style="font-size: 1.25rem; color: #ccc; margin: 0.5rem 0;">${movie.year} ‚Ä¢ ‚≠ê ${movie.rating}</p>
                      <p style="font-size: 1.5rem; color: #2ecc71; margin: 0.5rem 0; font-weight: bold;">‚ù§Ô∏è ${movie.likes} like(s)</p>
                  </div>
              `;
          });

          resultsHTML += '</div>';
          movieSection.innerHTML = resultsHTML;
      }

      const content = `
        <div class="text" style="background: rgba(115, 110, 225, 0.2); padding: 15px; border-radius: 8px; margin: 10px 0;">
            <span>
                <strong style="color: #736ee1;">üèÜ VOTING COMPLETE!</strong><br/>
                <p style="margin-top: 10px;">Check out the results in the movie section!</p>
            </span>
        </div>
      `;
      messages.innerHTML += content;
      messages.scrollTop = messages.scrollHeight;
  });




  socket.on('updated_feed', (data) => {
      const cardStack = document.getElementById('card-stack');
      if (!cardStack) return; // Only update if movie section exists

      const existingIds = new Set(
          Array.from(cardStack.querySelectorAll('.movie-card')).map(card => card.dataset.movieId)
      );

      const currentZIndex = cardStack.querySelectorAll('.movie-card').length;

      // Add new recommended movies to bottom of stack
      data.movies.forEach((movie, idx) => {
          if (!existingIds.has(movie.id)) {
              const card = document.createElement('div');
              card.className = 'movie-card';
              card.dataset.movieId = movie.id;
              card.style.zIndex = idx;
              const posterHTML = movie.poster && movie.poster !== 'N/A'
                  ? `<img src="${movie.poster}" alt="${movie.title}" class="poster-img">`
                  : '';
              const genreHTML = movie.genre && movie.genre !== 'N/A'
                  ? `<p class="movie-genre">${movie.genre}</p>`
                  : '';
              const plotHTML = movie.plot && movie.plot !== 'No description available.'
                  ? `<p class="movie-plot">${movie.plot}</p>`
                  : '';

              card.innerHTML = `
                  <div class="movie-poster">
                      ${posterHTML}
                      <div class="movie-info">
                          <h3>${movie.title}</h3>
                          <p class="movie-meta">${movie.year} ‚Ä¢ ‚≠ê ${movie.rating}</p>
                          ${genreHTML}
                          ${plotHTML}
                      </div>
                  </div>
              `;

              // Insert at beginning (bottom of stack)
              const noCardsMsg = document.getElementById('no-more-cards');
              cardStack.insertBefore(card, noCardsMsg);
              initCard(card);
          }
      });

      checkNoCards();
  });

  function copyText(text) {

      navigator.clipboard.writeText(text).then(() => {
          alert('Link copied to clipboard!');
      }).catch(err => {
          console.error('Failed to copy text: ', err);
      });
  }

  {% if not chat_started %}
  socket.emit('check_all_surveys_complete');
  {% endif %}

  // Load existing messages
  {% for msg in messages %}
      createMessage("{{msg.name}}", "{{msg.message}}");
  {% endfor %}
</script>

{% endblock %}
